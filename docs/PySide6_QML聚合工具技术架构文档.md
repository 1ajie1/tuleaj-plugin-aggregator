# tuleaj-plugin-aggregator 技术架构文档

## 项目概述

基于 PySide6 和 QML 构建的插件化聚合工具，支持动态加载、热启动/关闭插件，提供统一的进程管理界面。

## 技术架构

### 1. 核心技术栈

#### 1.1 前端技术
- **PySide6**: Python 的 Qt 绑定，提供 QML 支持
- **QML**: 声明式 UI 语言，构建现代化界面
- **Qt Quick Controls**: 丰富的 UI 组件库

#### 1.2 后端技术
- **Python 3.11+**: 主要开发语言
- **uv**: 轻量级 Python 包管理工具
- **subprocess**: 进程管理和通信

### 2. 系统架构设计

#### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────┐
│                   主程序 (聚合器)                        │
├─────────────────────────────────────────────────────────┤
│  QML 界面层                                              │
│  ┌─────────────┐  ┌─────────────────────────────────────┐ │
│  │  插件列表   │  │          插件文档展示区域            │ │
│  │   (左侧)    │  │     ┌─────────────────────────────┐ │ │
│  │             │  │     │                             │ │ │
│  │ - 插件A     │  │     │     插件 README.md          │ │ │
│  │ - 插件B     │  │     │                             │ │ │
│  │ - 插件C     │  │     │   - 插件描述                │ │ │
│  │             │  │     │   - 功能特性                │ │ │
│  │ 启动/停止   │  │     │   - 使用方法                │ │ │
│  │ 控制按钮    │  │     │   - 配置说明                │ │ │
│  └─────────────┘  └─────┴─────────────────────────────┘ │
├─────────────────────────────────────────────────────────┤
│  Python 后端层                                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐   │
│  │  插件管理器  │  │  进程管理器  │  │ 生命周期管理器   │   │
│  └─────────────┘  └─────────────┘  └─────────────────┘   │
├─────────────────────────────────────────────────────────┤
│  插件层 (独立进程)                                       │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐   │
│  │   插件A     │  │   插件B     │  │   插件C         │   │
│  │ (独立进程)  │  │ (独立进程)  │  │ (独立进程)      │   │
│  └─────────────┘  └─────────────┘  └─────────────────┘   │
└─────────────────────────────────────────────────────────┘
```

#### 2.2 核心组件

##### 2.2.1 插件管理器 (PluginManager)
- **职责**: 插件的发现、安装、配置管理
- **功能**: 扫描插件目录、读取配置、管理依赖、跟踪状态、解析README文档

##### 2.2.2 进程管理器 (ProcessManager)
- **职责**: 管理插件独立进程生命周期
- **功能**: 启动/停止进程、状态监控、资源清理
- **特点**: 不管理插件内部功能，只负责进程级别管理

##### 2.2.3 通信管理器 (CommunicationManager)
- **职责**: 主程序与插件间的通信
- **功能**: 进程间通信、状态同步、事件通知
- **特点**: 只负责进程级别通信，不涉及插件内部管理

### 3. 插件系统设计

#### 3.1 设计理念
**核心理念**: 插件是独立的可执行程序，主程序只负责进程生命周期管理，插件的窗口和托盘功能由插件自己实现。

#### 3.2 插件包结构
```
plugin_example/
├── main.py              # 插件入口文件 (必需)
├── README.md            # 插件文档 (必需)
├── ui/
│   └── main.qml         # 插件UI界面
├── resources/           # 资源文件
│   ├── icon.png         # 插件图标
│   └── tray_icon.png    # 托盘图标
└── pyproject.toml       # 插件配置
```

#### 3.3 插件配置规范
- **pyproject.toml**: 定义插件元数据、依赖、入口点
- **main.py**: 插件独立运行入口，实现窗口和托盘管理
- **README.md**: 插件文档，包含描述、功能、使用方法
- **QML界面**: 插件自己的用户界面

#### 3.4 插件独立管理
- **窗口管理**: 插件自己控制窗口显示/隐藏/最小化
- **托盘功能**: 插件独立实现系统托盘功能
- **进程隔离**: 主程序只负责启动/停止插件进程
- **状态独立**: 插件状态与主程序界面独立，不进行同步

#### 3.5 插件文档展示
- **README.md**: 每个插件必须包含 README.md 文档
- **文档内容**: 包含插件描述、功能特性、使用方法、配置说明
- **实时展示**: 主程序右侧区域实时展示选中插件的文档内容
- **Markdown渲染**: 支持 Markdown 格式的文档渲染和显示


### 4. 插件运行机制

#### 4.1 插件启动流程
1. **检查状态**: 验证插件是否已运行
2. **构建命令**: 使用 `uv run` 构建启动命令
3. **启动进程**: 通过 `subprocess` 启动插件进程
4. **注册监控**: 记录进程信息并开始监控
5. **状态同步**: 更新主程序界面状态

#### 4.2 进程生命周期管理
- **启动管理**: 使用 `uv run` 启动插件独立进程
- **状态监控**: 实时监控进程运行状态
- **优雅停止**: 先尝试 `terminate()`，超时后 `kill()`
- **资源清理**: 进程退出后清理相关资源

#### 4.3 通信机制
- **进程间通信**: 通过进程信号和退出码
- **状态同步**: 主程序监控插件进程状态
- **事件通知**: 插件状态变化时通知主程序界面

### 5. 性能优化策略

#### 5.1 内存管理
- **进程隔离**: 插件独立进程，避免内存泄漏
- **资源清理**: 及时清理未使用的插件资源
- **弱引用**: 避免循环引用问题

#### 5.2 启动优化
- **按需加载**: 插件按需启动，不预加载
- **异步初始化**: 非阻塞的插件启动流程
- **缓存机制**: 插件配置和状态缓存

### 6. 项目结构

```
monitor/
├── src/
│   ├── main.py                 # 主程序入口
│   ├── core/                   # 核心模块
│   │   ├── plugin_manager.py
│   │   ├── process_manager.py
│   │   └── communication.py
│   ├── ui/                     # QML 界面
│   │   ├── main.qml
│   │   ├── PluginListPanel.qml
│   │   └── PluginContainer.qml
│   └── plugins/                # 插件目录
├── plugins/                    # 插件开发目录
├── tests/                      # 测试代码
├── pyproject.toml              # 项目配置
└── README.md
```

### 7. 混合打包架构

#### 7.1 主程序打包 (PyInstaller)
- **打包方式**: 使用 PyInstaller 打包成独立可执行文件
- **优势**: 用户无需安装 Python 环境，一键启动
- **包含内容**: Python 解释器、PySide6、核心模块、uv 包管理器

#### 7.2 插件打包 (uv build)
- **打包方式**: 使用 `uv build` 打包成 wheel 包
- **优势**: 包体积小，支持热加载，符合 Python 生态
- **包结构**: 只包含插件代码，不包含第三方依赖

#### 7.3 混合架构优势
- **用户体验**: 主程序直接运行，无需环境配置
- **插件灵活性**: 支持动态安装、更新、卸载插件
- **包体积**: 插件保持轻量化，按需安装
- **开发友好**: 符合 Python 开发习惯

### 8. 依赖管理系统

#### 8.1 动态依赖安装
- **依赖解析**: 从插件 wheel 包中解析依赖信息
- **环境隔离**: 使用 uv 在指定环境中安装依赖
- **代理支持**: 支持 HTTP/SOCKS 代理配置
- **缓存策略**: 插件本身使用 `--no-cache`，第三方库依赖可使用缓存

#### 8.2 多环境支持
- **环境管理**: 支持多个 Python 环境
- **环境切换**: 动态切换当前使用的环境
- **版本隔离**: 不同环境运行不同版本的插件
- **环境创建**: 使用 uv 创建新的虚拟环境

#### 8.3 代理配置
- **代理类型**: 支持 HTTP 和 SOCKS 代理
- **环境变量**: 自动设置相关环境变量
- **命令行参数**: 为 uv 命令添加代理参数

#### 8.4 缓存策略
- **插件安装**: 使用 `--no-cache` 确保获取最新版本插件
- **依赖安装**: 使用默认缓存策略，提高安装速度
- **缓存清理**: 支持手动清理 uv 缓存
- **版本控制**: 插件版本更新时自动清理相关缓存

### 9. 插件管理流程

#### 9.1 插件安装流程
1. **兼容性检查**: 验证插件与当前环境的兼容性
2. **插件安装**: 使用 `uv pip install --no-cache` 安装插件 wheel 包
3. **依赖安装**: 使用 `uv pip install` 安装插件的第三方库依赖（可使用缓存）
4. **文档解析**: 解析插件的 README.md 文档内容
5. **插件注册**: 将插件信息和文档内容注册到主程序

#### 9.2 插件运行流程
1. **环境选择**: 选择运行插件的 Python 环境
2. **进程启动**: 使用 `uv run` 启动插件独立进程
3. **状态监控**: 实时监控插件进程状态
4. **资源管理**: 管理插件进程的生命周期

#### 9.3 插件卸载流程
1. **进程停止**: 先停止正在运行的插件进程
2. **包卸载**: 使用 `uv pip uninstall` 卸载插件
3. **依赖清理**: 清理不再需要的依赖包
4. **注册清理**: 从主程序中移除插件信息

### 10. 配置管理

#### 10.1 主程序配置
- **配置文件**: 使用 TOML 格式的 `config.toml`
- **配置内容**: 主程序名称、版本、默认环境、代理设置
- **环境配置**: 定义可用的 Python 环境路径
- **插件配置**: 自动加载插件列表、插件目录路径

#### 10.2 插件配置
- **pyproject.toml**: 插件元数据、依赖、入口点配置
- **插件元数据**: 名称、版本、描述、作者信息
- **依赖管理**: 插件所需的第三方包列表
- **入口点**: 插件主入口文件和可执行名称

#### 10.3 配置管理特性
- **默认配置**: 提供合理的默认配置值
- **配置验证**: 验证配置文件的完整性和有效性
- **热重载**: 支持配置文件的动态重载
- **环境变量**: 支持通过环境变量覆盖配置

## 技术优势

### 1. 架构优势
- **职责分离**: 主程序专注进程管理，插件独立管理功能
- **进程隔离**: 插件崩溃不影响主程序和其他插件
- **独立开发**: 插件可独立开发、测试、部署
- **配置驱动**: 通过配置文件控制插件行为

### 2. 用户体验优势
- **直观操作**: 主程序作为插件进程管理中心
- **文档展示**: 右侧区域实时展示插件的详细文档和使用说明
- **独立运行**: 插件关闭窗口不等于退出，支持后台运行
- **独立控制**: 每个插件有自己的托盘和窗口控制
- **系统集成**: 符合用户使用习惯的托盘操作

### 3. 开发优势
- **标准化**: 统一的插件开发接口和规范
- **轻量化**: 插件包体积小，按需安装
- **热更新**: 支持插件热更新，无需重启主程序
- **环境隔离**: 支持多个 Python 环境，避免依赖冲突

## 适用场景

- **系统监控工具**: 多个监控插件独立运行
- **开发工具集**: 各种开发工具的聚合管理
- **办公套件**: 多个办公应用的统一管理
- **多媒体工具**: 音视频处理工具的集成

## 总结

这个架构提供了一个灵活、用户友好的插件化聚合工具解决方案：

### 核心创新点
1. **插件独立运行**: 每个插件都是独立的可执行程序
2. **独立管理**: 插件自己管理窗口和托盘，主程序不干预
3. **进程生命周期管理**: 主程序只负责插件的启动/停止
4. **配置驱动**: 通过配置文件控制插件行为，无需编程

### 技术特性
1. **稳定性**: 进程隔离，插件崩溃不影响系统
2. **灵活性**: 插件可独立开发、测试、部署
3. **用户体验**: 直观的窗口管理和托盘操作
4. **开发效率**: 标准化的插件开发流程

通过这个架构，可以构建一个既强大又易用的插件化聚合工具，满足不同场景下的需求。
